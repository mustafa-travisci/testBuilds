#before_install:
#  - echo "$DOCKER_PASSWORD" | docker login --username $DOCKER_USERNAME --password-stdin
services:
  - docker
  - mysql
dist: xenial

language: bash
cache:
  bundler: true
  directories:
   - node_modules

addons:
  apt:
    sources:
      - sourceline: 'deb http://dl.yarnpkg.com/debian/ stable main'
        key_url: 'http://dl.yarnpkg.com/debian/pubkey.gpg'
      - sourceline: 'deb http://dl.google.com/linux/chrome/deb/ stable main'
        key_url: 'https://dl-ssl.google.com/linux/linux_signing_key.pub'
    packages:
      - postgresql-11
      - chromium-chromedriver
      - google-chrome-stable
      - yarn
      - redis-server
  postgresql: '11'

_test_gem_pg: &_test_gem_pg
  before_install:
    - sudo sed -i 's/port = 5433/port = 5432/' /etc/postgresql/11/main/postgresql.conf
    - sudo sed -i -e '/local.*peer/s/postgres/all/' -e 's/peer\|md5/trust/g' /etc/postgresql/*/main/pg_hba.conf
    - sudo service postgresql restart
    - sleep 1
    - sudo service postgresql stop
    - sudo service postgresql start 11
    - postgres --version
    - ln -s /usr/lib/chromium-browser/chromedriver ~/bin/chromedriver

  before_script:
    - psql -c 'create database "test_dbb";' -U postgres
    - google-chrome --version
    - which google-chrome
    - echo "test"

jobs:
  include:
    - <<: *_test_gem_pg
